name: Go
on: [push]
jobs:
  Build-on-unix:
    strategy:
      matrix:
        lua-version: [lua51, lua52, lua53, lua54]
        os: [macos, ubuntu]
    runs-on: ${{ matrix.os }}-latest
    steps:
    - name: Set up Go 
      uses: actions/setup-go@v3
      with:
        go-version: 1.21
      id: go
      
    - name: Check out code into the Go module directory
      uses: actions/checkout@v2

    - name: Build
      run: |
        cd golua/lua
        ./buildlua.sh
        cd -
        go build -ldflags="-s -w" -tags ${{ matrix.lua-version }} -o getnovel-${{ matrix.os }}-amd64-${{ matrix.lua-version }} .
        mkdir ${{ matrix.os }}-amd64
        cp getnovel-${{ matrix.os }}-amd64-${{ matrix.lua-version }} ${{ matrix.os }}-amd64/
        cp -r pdfpresets ${{ matrix.os }}-amd64/
        cp -r handlers ${{ matrix.os }}-amd64/
        cp -r lua ${{ matrix.os }}-amd64/
      
    - name: Upload artifact getnovel-${{ matrix.os }}-amd64
      uses: actions/upload-artifact@v1.0.0
      with:
        name: getnovel-${{ matrix.os }}-amd64-${{ matrix.lua-version }}
        path: ${{ matrix.os }}-amd64
     