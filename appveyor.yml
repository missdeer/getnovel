image: 
  - macos
  - Ubuntu

version: 1.6.3.{build}

branches:
    only:
        - master

environment:
    GOVERSION: 1.18.1
    matrix:
        - GOOS: windows
          GOARCH: amd64
          PREFIX: windows-amd64
          SUFFIX: .exe
          HOST: linux
        - GOOS: darwin
          GOARCH: amd64
          PREFIX: darwin-universal
          SUFFIX: 
          HOST: darwin
        - GOOS: linux
          GOARCH: amd64
          PREFIX: linux-amd64
          SUFFIX: 
          HOST: linux
        - GOOS: freebsd
          GOARCH: amd64
          PREFIX: freebsd-amd64
          SUFFIX: 
          HOST: linux
        - GOOS: netbsd
          GOARCH: amd64
          PREFIX: netbsd-amd64
          SUFFIX: 
          HOST: linux
        - GOOS: openbsd
          GOARCH: amd64
          PREFIX: openbsd-amd64
          SUFFIX: 
          HOST: linux
        - GOOS: dragonfly
          GOARCH: amd64
          PREFIX: dragonfly-amd64
          SUFFIX: 
          HOST: linux
        - GOOS: solaris
          GOARCH: amd64
          PREFIX: solaris-amd64
          SUFFIX: 
          HOST: linux
        - GOOS: linux
          GOARCH: arm
          GOARM: 5
          PREFIX: linux-armv5
          SUFFIX: 
          HOST: linux
        - GOOS: linux
          GOARCH: arm
          GOARM: 6
          PREFIX: linux-armv6
          SUFFIX: 
          HOST: linux
        - GOOS: linux
          GOARCH: arm
          GOARM: 7
          PREFIX: linux-armv7
          SUFFIX: 
          HOST: linux
        - GOOS: freebsd
          GOARCH: arm
          PREFIX: freebsd-arm
          SUFFIX: 
          HOST: linux
        - GOOS: netbsd
          GOARCH: arm
          PREFIX: netbsd-arm
          SUFFIX: 
          HOST: linux
        - GOOS: linux
          GOARCH: arm64
          PREFIX: linux-arm64
          SUFFIX: 
          HOST: linux
        - GOOS: linux
          GOARCH: ppc64
          PREFIX: linux-ppc64
          SUFFIX: 
          HOST: linux
        - GOOS: linux
          GOARCH: ppc64le
          PREFIX: linux-ppc64le
          SUFFIX: 
          HOST: linux
        - GOOS: linux
          GOARCH: mips64
          PREFIX: linux-mips64
          SUFFIX: 
          HOST: linux
        - GOOS: linux
          GOARCH: mips64le
          PREFIX: linux-mips64le
          SUFFIX: 
          HOST: linux
        - GOOS: linux
          GOARCH: mips
          PREFIX: linux-mips
          SUFFIX: 
          HOST: linux
        - GOOS: linux
          GOARCH: mipsle
          PREFIX: linux-mipsle
          SUFFIX: 
          HOST: linux
        - GOOS: linux
          GOARCH: s390x
          PREFIX: linux-s390x
          SUFFIX: 
          HOST: linux

matrix:
  exclude:
    - image: macos
      HOST: linux
    - image: Ubuntu
      HOST: darwin
      
clone_depth: 1

# scripts that run after cloning repository
install:
    - curl -O -L "https://storage.googleapis.com/golang/go$GOVERSION.$HOST-amd64.tar.gz"
    - tar xzf "go$GOVERSION.$HOST-amd64.tar.gz"
    - export GOROOT=$(pwd)/go
    - export PATH=$(pwd)/go/bin:$PATH

# scripts that run before build
before_build:
    - go env
    - go version

# custom build scripts
build_script:
    - if [ "$HOST" = "darwin" ]; then env GOARCH=amd64 go build -ldflags="-s" -o getnovel-amd64; env GOARCH=arm64 go build -ldflags="-s" -o getnovel-arm64; lipo -create -output getnovel-$PREFIX$SUFFIX getnovel-amd64 getnovel-arm64; else go build -ldflags="-s" -o "getnovel-$PREFIX$SUFFIX"; fi 
    - cd ..

# scripts that run after build
after_build:
    - mkdir -p "distrib/getnovel-$PREFIX/preset"
    - cp "$APPVEYOR_BUILD_FOLDER/preset/*" "distrib/getnovel-$PREFIX/preset/"
    - cp "$APPVEYOR_BUILD_FOLDER/getnovel-$PREFIX$SUFFIX" "distrib/getnovel-$PREFIX/getnovel$SUFFIX"
    - cd distrib
    - zip -r "getnovel-$PREFIX.zip" "getnovel-$PREFIX"

artifacts:
    - path: distrib/getnovel-$PREFIX.zip
      name: getnovel_package
